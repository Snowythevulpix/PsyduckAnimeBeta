<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Psyduckanime - The best place to watch Pokemon without ads</title>
  <meta property="og:title" content="Psyduckanime - The best place to watch Pokemon without ads"/>
  <meta property="og:image" content="/assets/Psyduck.png"/>
  <!-- Favicon -->
  <link rel="icon" href="/assets/Psyduck.png"/>
  <link rel="stylesheet" href="/assets/style.css">
  <!-- Clappr CDN -->
  <script async src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
</head>
<body>
  <!-- Home button image -->
  <a href="/">
    <img class="home-button" src="/assets/logo.png" alt="Home">
  </a>

  <!-- Clappr player container -->
  <div id="player-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const anilistid = urlParams.get('anilistid');
        const episode = urlParams.get('episode');
        const source = urlParams.get('source');
        const subtype = urlParams.get('subtype');

        const response = await fetch(`https://api.anify.tv/episodes/${anilistid}`);
        if (response.ok) {
          const data = await response.json();
          const providerData = data.find(provider => provider.providerId === source);
          if (providerData) {
            console.log('Available Provider IDs:', data.map(provider => provider.providerId)); // Log available provider ids
            const episodes = providerData.episodes;
            const targetEpisode = episodes.find(episodeObj => episodeObj.number === parseInt(episode));

            if (targetEpisode) {
              const id = targetEpisode.id;
              const videorequesturl = `https://api.anify.tv/sources?providerId=${source}&watchId=${id}&episodeNumber=${episode}&id=${anilistid}&subType=${subtype}`;

              const responseSources = await fetch(videorequesturl);

              if (responseSources.ok) {
                const sourcesData = await responseSources.json();
                let videourl = sourcesData.sources.find(source => source.quality === "auto");

                if (!videourl) {
                  videourl = sourcesData.sources.find(source => source.quality === "default");
                }

                if (videourl && videourl.url) {
                  var player = new Clappr.Player({
                    source: videourl.url,
                    parentId: '#player-container',
                  });

                  // Modified script begins here
                  async function makeRequest(url) {
                    const response = await fetch(url);
                    return await response.json();
                  }

                  if (subtype === "dub") {
                    const anifyResponse = await makeRequest(`https://api.anify.tv/info/${anilistid}`);
                    
                    const mappings = anifyResponse.mappings;
                    let malId = null;
                    
                    for (const mapping of mappings) {
                      if (mapping.providerId === "mal") {
                        malId = mapping.id;
                        break;
                      }
                    }

                    if (malId) {
                      const jikanResponse = await makeRequest(`https://api.jikan.moe/v4/anime/${malId}/episodes`);
                      
                      const episodeData = jikanResponse.data.find(episodeInfo => episodeInfo.mal_id === parseInt(episode));
                      
                      if (episodeData) {
                        const title = episodeData.title;
                        console.log(`You're watching episode ${episode} - ${title}`);
                        
                        const playerElement = document.getElementById('player-container'); 
                        const titleElement = document.createElement('div');
                        titleElement.innerText = `You're watching episode ${episode} - ${title}`;
                        titleElement.style.fontSize = '24px'; // Increase text size
                        playerElement.insertBefore(titleElement, playerElement.firstChild);
                      } else {
                        console.log(`Episode ${episode} not found.`);
                      }
                    } else {
                      console.log("MAL ID not found in mappings.");
                    }
                  } else {
                    console.log("Subtype is not 'dub'.");
                  }
                  // Modified script ends here

                } else {
                  console.log('Video URL not found.');
                }
              } else {
                console.log(`Failed to fetch episode data for episode ${episode}`);
              }
            } else {
              console.log('Episode not found for the given number.');
            }
          } else {
            console.log('Provider not found for the given source.');
          }
        } else {
          console.log('Failed to fetch provider data.');
        }
      } catch (error) {
        console.error('Error fetching provider data:', error);
      }
    });
  </script>
</body>
</html>
