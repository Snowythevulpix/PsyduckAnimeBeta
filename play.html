<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Psyduckanime - The best place to watch Pokemon without ads</title>
  <meta property="og:title" content="Psyduckanime - The best place to watch Pokemon without ads"/>
  <meta property="og:image" content="/assets/Psyduck.png"/>
  <!-- Favicon -->
  <link rel="icon" href="/assets/Psyduck.png"/>
  <link rel="stylesheet" href="/assets/style.css">
  <!-- Clappr CDN -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
</head>
<body>
  <!-- Home button image -->
  <a href="/">
    <img class="home-button" src="/assets/logo.png" alt="Home">
  </a>

  <!-- Clappr player container -->
  <div id="player-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const anilistid = urlParams.get('anilistid');
        const episode = urlParams.get('episode');
        const source = urlParams.get('source');
        const subtype = urlParams.get('subtype');

        // Printing the variables
        console.log('anilist id:', anilistid);
        console.log('episode:', episode);
        console.log('source:', source);
        console.log('subtype:', subtype);

        // Make API request to fetch data
        const response = await fetch(`https://api.anify.tv/episodes/${anilistid}`);
        if (response.ok) {
          const data = await response.json();
          // Find the providerId object that matches the 'source'
          const providerData = data.find(provider => provider.providerId === source);
          if (providerData) {
            console.log('Provider Data:', providerData);
            const episodes = providerData.episodes;

            // Find the episode object matching the given episode number
            const targetEpisode = episodes.find(episodeObj => episodeObj.number === parseInt(episode));
            
            if (targetEpisode) {
              console.log('Target Episode:', targetEpisode);
              // Accessing the id of the target episode
              const id = targetEpisode.id;
              console.log('ID:', id);

              const videorequesturl = `https://api.anify.tv/sources?providerId=${source}&watchId=${id}&episodeNumber=${episode}&id=${anilistid}&subType=${subtype}`;

              // Fetch the video URL using videorequesturl
              const responseSources = await fetch(videorequesturl);

              if (responseSources.ok) {
                const sourcesData = await responseSources.json();
                // Find the auto video URL from the episode data
                const videourl = sourcesData.sources.find(source => source.quality === "auto");

                if (videourl && videourl.url) {
                  console.log('auto Video URL:', videourl.url);

                  // Create the Clappr player using the obtained video URL
                  var player = new Clappr.Player({
                    source: videourl.url, // Use the fetched video URL as the source
                    parentId: '#player-container',
                    // Additional configurations can be added as needed based on the documentation
                  });
                } else {
                  console.log('auto Video URL not found.');
                }
              } else {
                console.log(`Failed to fetch episode data for episode ${episode}`);
              }
            } else {
              console.log('Episode not found for the given number.');
            }
          } else {
            console.log('Provider not found for the given source.');
          }
        } else {
          console.log('Failed to fetch provider data.');
        }
      } catch (error) {
        console.error('Error fetching provider data:', error);
      }
    });
  </script>
</body>
</html>
